# Техническая архитектура

## Общий обзор

AI Classifieds Ad Generator — это веб-приложение на Next.js (App Router), использующее гибридную архитектуру. Клиентская часть отвечает за UI и валидацию, а серверная часть (API Routes) управляет взаимодействием с AI и базой данных.

## Архитектура системы

```
┌─────────────────────────────────────────────────────────┐
│                     Клиент (Браузер)                     │
│  ┌─────────────────────────────────────────────────┐    │
│  │           Next.js 16 (App Router)              │    │
│  │  ┌──────────┐  ┌──────────┐  ┌────────────┐    │    │
│  │  │  Pages   │  │Components│  │  Services  │    │    │
│  │  │          │  │          │  │            │    │    │
│  │  │ /        │  │AdGenerator│ │ gemini    │    │    │
│  │  │ /app     │  │InputField│  │ analytics │    │    │
│  │  │          │  │...       │  │           │    │    │
│  │  └──────────┘  └──────────┘  └────────────┘    │    │
│  └───────────────────────┬─────────────────────────┘    │
│                          │ HTTPS (fetch)                 │
└──────────────────────────┼──────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────┐
│                     Сервер (Vercel)                      │
│  ┌─────────────────────────────────────────────────┐    │
│  │           Next.js API Routes (Edge/Node)        │    │
│  │  ┌──────────────┐      ┌─────────────────────┐  │    │
│  │  │ /api/generate│◄────►│ Google GenAI SDK    │  │    │
│  │  └──────────────┘      │ (Server-side key)   │  │    │
│  │                        └──────────┬──────────┘  │    │
│  │  ┌──────────────┐                 │ HTTPS       │    │
│  │  │ /api/optimize│◄────────────────┘             │    │
│  │  └──────┬───────┘                               │    │
│  │         │                                       │    │
│  └─────────┼───────────────────────────────────────┘    │
│            │                                            │
└────────────┼────────────────────────────────────────────┘
             │ Async Insert                                
             ▼                                            
┌─────────────────────────┐      ┌─────────────────────────┐
│        Supabase         │      │      Google Gemini      │
│  ┌───────────────────┐  │      │  ┌───────────────────┐  │
│  │ Database (Postgres)│  │      │  │ Gemini Flash     │  │
│  │ Table:            │  │      │  │ Models            │  │
│  │  - generated_ads  │  │      │  │                   │  │
│  └───────────────────┘  │      │  └───────────────────┘  │
└─────────────────────────┘      └─────────────────────────┘
```

## Стек технологий

### Frontend Core
| Технология | Версия | Назначение |
|------------|--------|------------|
| Next.js | 16.1.6 | React фреймворк с App Router |
| React | 19.2.4 | UI библиотека |
| TypeScript | 5.5.3 | Типизация |

### Backend & Services
| Технология | Назначение |
|------------|------------|
| Next.js API Routes | Серверные эндпоинты для скрытия ключей и логики |
| Supabase | База данных (PostgreSQL) для хранения истории |
| Google GenAI SDK | Серверная интеграция с Gemini API |

### Стилизация
| Технология | Версия | Назначение |
|------------|--------|------------|
| TailwindCSS | v4.1.18 | Утилитарный CSS фреймворк |
| @tailwindcss/postcss | v4 | PostCSS плагин для Tailwind v4 |

## Структура проекта

```
d:\Work\Projects\ai-classifieds-ad-generator/
├── app/                          # Next.js App Router
│   ├── api/                      # API Routes
│   │   ├── generate/             # Генерация объявлений
│   │   └── optimize/             # SEO оптимизация
│   ├── globals.css               # Глобальные стили
│   ├── layout.tsx                # Корневой layout
│   └── page.tsx                  # Главная страница
│
├── components/                   # React компоненты
│   ├── AdGenerator.tsx           # Основной компонент
│   ├── ...                       # UI компоненты
│
├── services/                     # Клиентские сервисы
│   ├── geminiService.ts          # Клиент для API (/api/*)
│   ├── adHelpers.ts              # Общая логика промптов
│   ├── supabase.ts               # Клиент Supabase
│   └── analytics.ts              # Google Analytics
│
├── supabase/                     # Supabase конфигурация
│   └── migrations/               # SQL миграции
│
├── docs/                         # Документация
├── public/                       # Статика
└── ...                           # Конфиги
```

## Ключевые технические решения

### 1. Серверная генерация (API Routes)

**Почему**: Переход с клиентской генерации на серверную позволил скрыть API ключи и улучшить безопасность.

**Как работает**:
- Клиент отправляет POST запрос на `/api/generate`.
- Сервер использует `GOOGLE_API_KEY` для обращения к Gemini.
- Реализована логика повторных попыток (Retry) для обработки ошибок 503 и 429.

### 2. Интеграция с Supabase

Все успешные генерации асинхронно сохраняются в базу данных:
- Таблица: `generated_ads`
- Поля: `id`, `category`, `input_data` (JSON), `output_text`, `tone`, `created_at`.
- Изображения (base64) удаляются из `input_data` перед сохранением для экономии места.

### 3. Отказоустойчивость (Retry Logic)

В API реализован механизм экспоненциальной задержки (Exponential Backoff):
- При ошибках 503 (Overloaded) или 429 (Too Many Requests).
- 3 попытки с интервалами 1s, 2s, 4s.
- Автоматическое переключение моделей (fallback) при необходимости.

### 4. Безопасность

- **API Keys**: Ключи Google хранятся только на сервере (`GOOGLE_API_KEY`).
- **Supabase**: Используется `NEXT_PUBLIC_SUPABASE_ANON_KEY` для клиента и сервисные роли при необходимости (на сервере).

### 5. Производительность

- **Edge/Node Runtime**: API роуты оптимизированы для быстрого старта.
- **Non-blocking Save**: Сохранение в Supabase происходит без блокировки ответа пользователю (`fire-and-forget`).
